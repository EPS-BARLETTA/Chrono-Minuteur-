<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Chrono avec vitesse</title>
<script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
<script src="./qr-overlay.js"></script>
</head>
<body style="margin:0;background:#0f172a;color:#e5e7eb;font:16px/1.45 system-ui">
<style>
  :root{--gA:#06b6d4;--gB:#22c55e}
  .wrap{min-height:100dvh;display:grid;grid-template-rows:auto 1fr auto}
  header,footer{padding:10px 12px}
  footer{background:#e5e7eb;color:#111827;text-align:center;font-weight:700}
  .back{color:#a3aed5;text-decoration:none}
  .main{display:grid;place-items:center;padding:18px}
  .card{background:#111827;border:1px solid #1f2937;border-radius:18px;padding:18px;max-width:900px;width:94vw;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .grid{display:grid;gap:12px} @media(min-width:780px){.cols-4{grid-template-columns:repeat(4,1fr)}}
  label{display:block;font-weight:800;margin:0 0 6px}
  input,select{width:100%;padding:12px;border-radius:12px;border:1px solid #334155;background:#0b1222;color:#e5e7eb}
  input[type=number]{-moz-appearance:textfield} input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0;}
  .fg{padding:2px;border-radius:14px;background:linear-gradient(135deg,var(--gA),var(--gB))}
  .fg .inner{background:#0b1222;border-radius:12px;padding:10px;border:1px solid #1f2a43}
  .time{font-size:clamp(72px,26vmin,300px);font-weight:900;text-align:center;margin:8px 0}
  .row{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
  .btn{padding:14px 18px;border:0;border-radius:12px;font-weight:900;cursor:pointer;min-width:180px}
  .btn-acc{background:#4f46e5;color:#fff}.btn-ok{background:#10b981;color:#083d31}
  .btn-warn{background:#f59e0b;color:#1f1400}.btn-dgr{background:#ef4444;color:#2b0a0a}
  .muted{color:#94a3b8}
  body.fs header, body.fs footer, body.fs .form, body.fs .res{display:none}
  body.fs .card{background:transparent;border:0;box-shadow:none;padding:0;width:100vw;max-width:100vw}
  body.fs .time{font-size:clamp(96px,32vmin,360px)}
  body.fs .btn{padding:24px 28px;font-size:clamp(18px,3.2vw,26px);border-radius:18px}
</style>
<div class="wrap">
  <header><a class="back" href="./modes.html">← Modes</a></header>
  <main class="main">
    <div class="card">
      <h2 style="margin:6px 0 10px">Chrono avec vitesse</h2>
      <div class="form">
        <div class="grid cols-4">
          <div class="fg"><div class="inner"><label>Nom</label><input id="nom" placeholder="Martin" inputmode="text"></div></div>
          <div class="fg"><div class="inner"><label>Prénom</label><input id="prenom" placeholder="Julie" inputmode="text"></div></div>
          <div class="fg"><div class="inner"><label>Classe</label><input id="classe" placeholder="4C" inputmode="text"></div></div>
          <div class="fg"><div class="inner"><label>Sexe</label><select id="sexe"><option value="F">F</option><option value="M">M</option></select></div></div>
        </div>
        <div class="grid" style="margin-top:10px">
          <div class="fg"><div class="inner"><label>Distance (m)</label><input id="dist" type="number" value="100" min="10" step="10" inputmode="numeric"></div></div>
        </div>
      </div>
      <div class="time" id="time">0:00.00</div>
      <div class="row">
        <button id="b-start" class="btn btn-acc">Démarrer</button>
        <button id="b-stop" class="btn btn-warn" disabled>Stop</button>
        <button id="b-reset" class="btn btn-dgr" disabled>Réinitialiser</button>
        <button id="b-full" class="btn btn-ok">Plein écran</button>
      </div>
      <div id="res" class="muted res" style="margin-top:12px"></div>
      <div class="row" style="margin-top:10px">
        <button id="b-qr" class="btn btn-acc" disabled>QR ScanProf</button>
      </div>
    </div>
  </main>
  <footer>ChronoMinuteur - Equipe EPS Lycée Vauban - LUXEMBOURG - JB</footer>
</div>

<script>
  let __AC__ = null;
  function audioCtx(){
    if(!__AC__){
      const Ctx = window.AudioContext || window.webkitAudioContext;
      __AC__ = new Ctx();
    }
    if(__AC__.state === 'suspended') __AC__.resume();
    return __AC__;
  }
  function beep(freq=880, duration=0.18, volume=0.2){
    const ac = audioCtx();
    const o = ac.createOscillator();
    const g = ac.createGain();
    o.type = 'sine'; o.frequency.value = freq;
    g.gain.setValueAtTime(volume, ac.currentTime);
    g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime + duration);
    o.connect(g).connect(ac.destination);
    o.start(); o.stop(ac.currentTime + duration);
  }
  function patternStart(){ beep(880,0.18,0.25); }
  function patternEnd(){ beep(440,0.25,0.25); setTimeout(()=>beep(440,0.25,0.25), 120); }
</script>

<script>
  const $=s=>document.querySelector(s);
  let run=false,t0=0,acc=0,raf=null,finalMs=null;
  function fmtHundredths(t){ const hh=Math.floor((t%1000)/10); const s=Math.floor(t/1000)%60; const m=Math.floor(t/60000); return m+':'+String(s).padStart(2,'0')+'.'+String(hh).padStart(2,'0'); }
  function tick(){ if(!run) return; const t=Date.now()-t0+acc; $('#time').textContent=fmtHundredths(t); raf=requestAnimationFrame(tick); }
  $('#b-start').onclick=()=>{ if(run) return; run=true;t0=Date.now();patternStart();$('#b-start').disabled=true;$('#b-stop').disabled=false;$('#b-reset').disabled=true;$('#b-qr').disabled=true;tick(); };
  $('#b-stop').onclick=()=>{ if(!run) return; run=false;acc+=Date.now()-t0;cancelAnimationFrame(raf);finalMs=acc; patternEnd();
    const dist=Number($('#dist').value||0); const sec=finalMs/1000; const v= dist>0 && sec>0 ? (dist/sec)*3.6 : 0;
    $('#res').innerHTML=`Temps : <b>${fmtHundredths(finalMs)}</b> — Vitesse : <b>${v.toFixed(2)} km/h</b>`;
    $('#b-start').disabled=false;$('#b-stop').disabled=true;$('#b-reset').disabled=false;$('#b-qr').disabled=false;
  };
  $('#b-reset').onclick=()=>{ run=false;acc=0;finalMs=null;$('#time').textContent='0:00.00';$('#res').textContent='';$('#b-qr').disabled=true; };
  function toggleFS(){ if(!document.fullscreenElement){ document.documentElement.requestFullscreen(); } else { document.exitFullscreen(); } }
  $('#b-full').onclick=toggleFS;
  document.addEventListener('fullscreenchange', ()=>{ document.body.classList.toggle('fs', !!document.fullscreenElement); });
  $('#b-qr').onclick=()=>{
    const nom=$('#nom').value.trim(), prenom=$('#prenom').value.trim(), classe=$('#classe').value.trim();
    let sexe=$('#sexe').value; sexe = (sexe==='M'||sexe==='F')?sexe:'F';
    const dist=Number($('#dist').value||0); if(!nom||!prenom||!classe){ alert('Identité incomplète.'); return; }
    if(!finalMs){ alert('Aucun résultat.'); return; }
    const sec=(finalMs||0)/1000; const v= dist>0 && sec>0 ? (dist/sec)*3.6 : 0;
    const payload = { nom, prenom, classe, sexe, Mode:"Chrono vitesse", Distance_m:dist, Temps: fmtHundredths(finalMs), Vitesse_kmh: Number(v.toFixed(2)) };
    showQROverlay(payload, `QR_${nom}_${prenom}`);
  };
</script>
</body>
</html>
