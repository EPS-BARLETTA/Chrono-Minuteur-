<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Chrono avec vitesse</title>
<script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
<script src="./qr-overlay.js"></script>
</head>
<body style="margin:0;background:#0f172a;color:#e5e7eb;font:16px/1.45 system-ui">
<style>
  .wrap{min-height:100dvh;display:grid;grid-template-rows:auto 1fr auto}
  header,footer{padding:10px 12px}
  footer{background:#e5e7eb;color:#111827;text-align:center;font-weight:700}
  .back{color:#a3aed5;text-decoration:none}
  .main{display:grid;place-items:center;padding:18px}
  .card{background:#111827;border:1px solid #1f2937;border-radius:18px;padding:18px;max-width:900px;width:94vw;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .grid{display:grid;gap:12px} @media(min-width:780px){.cols-4{grid-template-columns:repeat(4,1fr)}}
  label{display:block;font-weight:700;margin:8px 0 6px}
  input,select{width:100%;padding:12px;border-radius:12px;border:1px solid #334155;background:#0b1222;color:#e5e7eb}
  .time{font-size:clamp(48px,14vmin,160px);font-weight:900;text-align:center;margin:8px 0}
  .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
  .btn{padding:12px 16px;border:0;border-radius:12px;font-weight:800;cursor:pointer}
  .btn-acc{background:#4f46e5;color:#fff}.btn-ok{background:#10b981;color:#083d31}
  .btn-warn{background:#f59e0b;color:#1f1400}.btn-dgr{background:#ef4444;color:#2b0a0a}
  .muted{color:#94a3b8}
</style>
<div class="wrap">
  <header><a class="back" href="./modes.html">← Modes</a></header>
  <main class="main">
    <div class="card">
      <h2 style="margin:6px 0 10px">Chrono avec vitesse</h2>
      <div class="grid cols-4">
        <div><label>Nom</label><input id="nom" placeholder="Martin"></div>
        <div><label>Prénom</label><input id="prenom" placeholder="Julie"></div>
        <div><label>Classe</label><input id="classe" placeholder="4C"></div>
        <div><label>Sexe</label>
          <select id="sexe"><option value="F">F</option><option value="M">M</option></select>
        </div>
      </div>
      <div class="grid" style="margin-top:10px">
        <div><label>Distance (m)</label><input id="dist" type="number" value="100" min="10" step="10"></div>
      </div>
      <div class="time" id="time">0:00.0</div>
      <div class="row">
        <button id="b-start" class="btn btn-acc">Démarrer</button>
        <button id="b-stop" class="btn btn-warn" disabled>Stop</button>
        <button id="b-reset" class="btn btn-dgr" disabled>Réinitialiser</button>
        <button id="b-full" class="btn btn-ok">Plein écran</button>
      </div>
      <div id="res" style="margin-top:12px" class="muted"></div>
      <div class="row" style="margin-top:10px">
        <button id="b-qr" class="btn btn-acc" disabled>QR ScanProf</button>
      </div>
    </div>
  </main>
  <footer>ChronoMinuteur - Equipe EPS Lycée Vauban - LUXEMBOURG - JB</footer>
</div>
<script>
  const $=s=>document.querySelector(s);
  let run=false,t0=0,acc=0,raf=null,finalMs=null;
  const fmt=t=>{const cs=Math.floor((t%1000)/100);const s=Math.floor(t/1000)%60;const m=Math.floor(t/60000);return m+':'+String(s%60).padStart(2,'0')+'.'+cs};
  function tick(){ if(!run) return; const t=Date.now()-t0+acc; $('#time').textContent=fmt(t); raf=requestAnimationFrame(tick); }
  $('#b-start').onclick=()=>{ if(run) return; run=true;t0=Date.now();$('#b-start').disabled=true;$('#b-stop').disabled=false;$('#b-reset').disabled=true;$('#b-qr').disabled=true;tick(); };
  $('#b-stop').onclick=()=>{ if(!run) return; run=false;acc+=Date.now()-t0;cancelAnimationFrame(raf);finalMs=acc; const dist=Number($('#dist').value||0); const sec=finalMs/1000; const v= dist>0 && sec>0 ? (dist/sec)*3.6 : 0;
    $('#res').innerHTML=`Temps : <b>${fmt(finalMs)}</b> — Vitesse : <b>${v.toFixed(2)} km/h</b>`;
    $('#b-start').disabled=false;$('#b-stop').disabled=true;$('#b-reset').disabled=false;$('#b-qr').disabled=false;
  };
  $('#b-reset').onclick=()=>{ run=false;acc=0;finalMs=null;$('#time').textContent='0:00.0';$('#res').textContent='';$('#b-qr').disabled=true; };
  $('#b-full').onclick=()=>{ if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); };
  $('#b-qr').onclick=()=>{
    const nom=$('#nom').value.trim(), prenom=$('#prenom').value.trim(), classe=$('#classe').value.trim();
    let sexe=$('#sexe').value; sexe = (sexe==='M'||sexe==='F')?sexe:'F';
    const dist=Number($('#dist').value||0); const sec=(finalMs||0)/1000; const v= dist>0 && sec>0 ? (dist/sec)*3.6 : 0;
    if(!nom||!prenom||!classe){ alert('Identité incomplète.'); return; }
    if(!finalMs){ alert('Aucun résultat.'); return; }
    const payload = {
      nom, prenom, classe, sexe,
      Mode: "Chrono vitesse",
      Distance_m: dist,
      Temps: (()=>{ const s=Math.round(sec); const m=Math.floor(s/60); return m+':'+String(s%60).padStart(2,'0'); })(),
      Vitesse_kmh: Number(v.toFixed(2))
    };
    showQROverlay(payload, `QR_${nom}_${prenom}`);
  };
</script>
</body>
</html>
