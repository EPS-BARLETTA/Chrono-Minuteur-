<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Minuteur distance & vitesse</title>
<script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
<script src="./qr-overlay.js"></script>
</head>
<body style="margin:0;background:#0f172a;color:#e5e7eb;font:16px/1.45 system-ui">
<style>
  .wrap{min-height:100dvh;display:grid;grid-template-rows:auto 1fr auto}
  header,footer{padding:10px 12px}
  footer{background:#e5e7eb;color:#111827;text-align:center;font-weight:700}
  .back{color:#a3aed5;text-decoration:none}
  .main{display:grid;place-items:center;padding:18px}
  .card{background:#111827;border:1px solid #1f2937;border-radius:16px;padding:18px;max-width:980px;width:94vw;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .grid{display:grid;gap:12px} @media(min-width:880px){.cols-4{grid-template-columns:repeat(4,1fr)}}
  label{display:block;font-weight:700;margin:8px 0 6px}
  input,select{width:100%;padding:12px;border-radius:12px;border:1px solid #334155;background:#0b1222;color:#e5e7eb}
  .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
  .btn{padding:12px 16px;border:0;border-radius:12px;font-weight:800;cursor:pointer}
  .btn-acc{background:#4f46e5;color:#fff}.btn-ok{background:#10b981;color:#083d31}
  .btn-warn{background:#f59e0b;color:#1f1400}.btn-dgr{background:#ef4444;color:#2b0a0a}
  .big{font-size:min(12vw,100px);font-weight:900;text-align:center;margin:10px 0}
  .muted{color:#94a3b8}
  .stat{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
  .box{background:#0b1222;border:1px solid #23304a;border-radius:12px;padding:10px;text-align:center}
  .box b{font-size:1.2rem}
</style>
<div class="wrap">
  <header><a class="back" href="./modes.html">← Modes</a></header>
  <main class="main">
    <div class="card">
      <h2 style="margin:6px 0 10px">Minuteur avec distance & vitesse</h2>
      <div class="grid cols-4">
        <div><label>Nom</label><input id="nom" placeholder="Martin"></div>
        <div><label>Prénom</label><input id="prenom" placeholder="Julie"></div>
        <div><label>Classe</label><input id="classe" placeholder="4C"></div>
        <div><label>Sexe</label><select id="sexe"><option value="F">F</option><option value="M">M</option></select></div>
      </div>
      <div class="grid cols-4" style="margin-top:10px">
        <div><label>Durée (minutes)</label><input id="mins" type="number" min="1" step="1" value="6"></div>
        <div><label>Longueur de piste (m)</label><input id="lapm" type="number" min="25" step="5" value="120"></div>
        <div><label>Tours comptés</label><input id="laps" type="number" value="0" disabled></div>
        <div><label>Distance totale (m)</label><input id="dist" type="number" value="0" disabled></div>
      </div>
      <div id="time" class="big">6:00</div>
      <div class="row">
        <button id="b-start" class="btn btn-acc">Lancer</button>
        <button id="b-lap" class="btn btn-ok" disabled>+1 tour</button>
        <button id="b-pause" class="btn btn-warn" disabled>Pause</button>
        <button id="b-reset" class="btn btn-dgr" disabled>Réinitialiser</button>
        <button id="b-full" class="btn btn-ok">Plein écran</button>
      </div>
      <div class="stat">
        <div class="box"><div class="muted">Vitesse moyenne</div><b id="v-kmh">0.00 km/h</b></div>
        <div class="box"><div class="muted">VMA estimée (≥6’)</div><b id="vma">—</b></div>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="b-fraction" class="btn btn-acc" disabled>+ 1/4 — 1/2 — 3/4 tour</button>
        <button id="b-qr" class="btn btn-acc" disabled>QR ScanProf</button>
      </div>
      <p class="muted" style="margin-top:6px">À la fin : ajoute une fraction si besoin, ça recalcule distance & vitesse (et VMA si durée ≥ 6 min).</p>
    </div>
  </main>
  <footer>ChronoMinuteur - Equipe EPS Lycée Vauban - LUXEMBOURG - JB</footer>
</div>
<script>
  const $=s=>document.querySelector(s);
  let dur=6*60, remain=dur, run=false, t0=0, raf=null;
  let laps=0, lapm=120, dist=0;
  function fmt(s){ s=Math.max(0,Math.round(s)); const m=Math.floor(s/60), ss=s%60; return m+':'+String(ss).padStart(2,'0'); }
  function kmh(m, s){ return (m>0 && s>0) ? (m/s)*3.6 : 0; }
  function draw(){ $('#time').textContent=fmt(remain); $('#laps').value=String(laps); $('#dist').value=String(dist);
    const v=kmh(dist, dur-remain); $('#v-kmh').textContent = v.toFixed(2)+' km/h';
    if(dur>=360){ $('#vma').textContent = v.toFixed(2)+' km/h'; } else { $('#vma').textContent='—'; }
  }
  function setInputs(){ dur=Math.max(1,Number($('#mins').value))*60; lapm=Math.max(1,Number($('#lapm').value)); if(!run){ remain=dur; draw(); } }
  $('#mins').oninput=setInputs; $('#lapm').oninput=setInputs; setInputs();

  function tick(){ if(!run) return; const now=Date.now(); remain = dur - (now - t0)/1000;
    if(remain<=0){ remain=0; run=false; cancelAnimationFrame(raf);
      $('#b-start').disabled=false; $('#b-pause').disabled=true; $('#b-reset').disabled=false; $('#b-lap').disabled=true; $('#b-fraction').disabled=false; $('#b-qr').disabled=false;
      alert('Terminé — ajoute une fraction si besoin.');
    }
    draw(); if(run) raf=requestAnimationFrame(tick);
  }

  $('#b-start').onclick=()=>{ if(run) return; run=true; t0=Date.now()-(dur-remain)*1000;
    $('#b-start').disabled=true; $('#b-pause').disabled=false; $('#b-reset').disabled=true; $('#b-lap').disabled=false; $('#b-fraction').disabled=true; $('#b-qr').disabled=true; tick();
  };
  $('#b-pause').onclick=()=>{ run=false; $('#b-start').disabled=false; $('#b-pause').disabled=true; $('#b-reset').disabled=false; };
  $('#b-reset').onclick=()=>{ run=false; remain=dur; laps=0; dist=0; draw(); $('#b-start').disabled=false; $('#b-pause').disabled=true; $('#b-reset').disabled=true; $('#b-lap').disabled=true; $('#b-fraction').disabled=true; $('#b-qr').disabled=true; };
  $('#b-lap').onclick=()=>{ if(!run) return; laps+=1; dist = laps*lapm; draw(); };
  $('#b-full').onclick=()=>{ if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); };

  $('#b-fraction').onclick=()=>{
    const choice = prompt('Ajouter une fraction de tour ? (entrer 0.25, 0.5, 0.75 ou 0)');
    const f = Number(choice||0);
    if([0,0.25,0.5,0.75].includes(f)){ dist = laps*lapm + f*lapm; draw(); } else { alert('Valeur invalide (0, 0.25, 0.5, 0.75)'); }
  };

  $('#b-qr').onclick=()=>{
    const nom=$('#nom').value.trim(), prenom=$('#prenom').value.trim(), classe=$('#classe').value.trim();
    let sexe=$('#sexe').value; sexe=(sexe==='M'||sexe==='F')?sexe:'F';
    if(!nom||!prenom||!classe){ alert('Identité incomplète.'); return; }
    const elapsed = dur-remain;
    const v = kmh(dist, elapsed);
    const payload = {
      nom, prenom, classe, sexe,
      Mode: "Minuteur distance",
      Duree_s: Math.round(dur),
      Piste_m: lapm,
      Tours: laps,
      Distance_m: Math.round(dist),
      Vitesse_kmh: Number(v.toFixed(2)),
      VMA: (dur>=360) ? Number(v.toFixed(2)) : undefined
    };
    showQROverlay(payload, `QR_${nom}_${prenom}`);
  };
</script>
</body>
</html>
