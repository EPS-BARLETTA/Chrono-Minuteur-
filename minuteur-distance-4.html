<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Minuteur distance & vitesse — v6.3</title>
<link rel="icon" href="data:,">
<script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
<script src="./qr-overlay.js"></script>
</head>
<body style="margin:0;background:#0f172a;color:#e5e7eb;font:16px/1.45 system-ui">
<style>
  :root{
    --gA:#ec4899;--gB:#ef4444;           /* gradient général inputs */
    --midA:#06b6d4;--midB:#22c55e;       /* midbar tours/distance/fraction */
    --msA:#6366f1;--msB:#a855f7;         /* Minutes/Secondes distinct */
  }
  .wrap{min-height:100dvh;display:grid;grid-template-rows:auto 1fr auto}
  header,footer{padding:10px 12px}
  footer{background:#e5e7eb;color:#111827;text-align:center;font-weight:700}
  .back{color:#a3aed5;text-decoration:none}
  .main{display:grid;place-items:center;padding:18px}
  .card{background:#111827;border:1px solid #1f2937;border-radius:18px;padding:18px;max-width:1000px;width:94vw;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .grid{display:grid;gap:12px}
  @media(min-width:920px){.cols-5{grid-template-columns:repeat(5,1fr)}}
  /* Titres/labels centrés partout */
  label{display:block;font-weight:800;margin:0 0 6px;text-align:center;font-size:clamp(14px,2.4vmin,20px)}
  /* Champs de saisie plus lisibles (nom, prénom, classe, etc.) */
  input,select{
    width:100%;padding:14px 14px;
    border-radius:12px;border:1px solid #334155;background:#0b1222;color:#e5e7eb;
    font-size:clamp(18px,2.8vmin,26px);
  }
  input::placeholder{color:#a8b3c7;opacity:.85;font-size:clamp(18px,2.8vmin,26px)}
  /* Inputs classiques */
  .fg{padding:2px;border-radius:14px;background:linear-gradient(135deg,var(--gA),var(--gB))}
  .fg .inner{background:#0b1222;border-radius:12px;padding:10px;border:1px solid #1f2a43}
  /* Minutes / Secondes : centrés + couleur différente */
  .time-row{display:grid;grid-template-columns:repeat(2,minmax(160px,220px));gap:12px;justify-content:center}
  .fg-ms{background:linear-gradient(135deg,var(--msA),var(--msB))}
  .fg-ms .inner{background:#0c1633;border-color:#2a375a}
  .ms-input{font-size:clamp(18px,2.8vmin,26px);text-align:center}
  /* Boutons — dominants par rapport à la midbar */
  .row{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
  .btn{
    padding:18px 24px;
    border:0;border-radius:14px;
    font-weight:900;
    cursor:pointer;min-width:200px;
    font-size:clamp(26px,6.4vmin,50px);
    line-height:1.05;
  }
  .btn-acc{background:#4f46e5;color:#fff}.btn-ok{background:#10b981;color:#083d31}
  .btn-warn{background:#f59e0b;color:#1f1400}.btn-dgr{background:#ef4444;color:#2b0a0a}
  /* Affichage temps */
  .big{font-size:clamp(72px,26vmin,300px);font-weight:900;text-align:center;margin:10px 0}
  .muted{color:#94a3b8;text-align:center}
  /* Stats vitesse */
  .stat{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
  .box{background:#0b1222;border:1px solid #23304a;border-radius:12px;padding:10px;text-align:center}
  .box b{font-size:1.2rem}
  /* ===== Midbar : tours / distance / fraction (gros + centrage) ===== */
  .midbar{margin:10px auto 0;display:grid;gap:10px;justify-items:center;background:linear-gradient(135deg,var(--midA),var(--midB));border-radius:16px;padding:12px;border:1px solid #134e4a}
  @media(min-width:900px){ .midbar{grid-template-columns:1fr auto} }
  .mid-left{display:grid;gap:10px;align-items:center;justify-items:center}
  @media(min-width:780px){ .mid-left{grid-template-columns:repeat(3,1fr)} }
  .pill{background:#0b1222;border:1px solid #1f2a43;border-radius:14px;padding:12px;display:grid;gap:6px;min-width:250px}
  .pill label{margin:0;opacity:.92;font-size:clamp(16px,2.8vmin,22px);text-align:center}
  .pill input{
    text-align:center;
    font-weight:900;
    font-size:clamp(24px,5.2vmin,46px); /* ↑ plus grand */
    letter-spacing:.5px;
    padding:12px 10px;
    border-radius:12px;
    border:1px dashed #2b3a5e;
    background:#0b1222;
    color:#f8fafc;
    opacity:1;
  }
  .mid-right{display:none;align-items:center;justify-content:center}
  .mid-right .fraction-panel{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
  .chip{border:0;border-radius:999px;padding:10px 14px;font-weight:900;cursor:pointer}
  .chip-0{background:#334155;color:#dbeafe}
  .chip-25{background:#1e293b;color:#86efac}
  .chip-50{background:#1e293b;color:#fef08a}
  .chip-75{background:#1e293b;color:#fca5a5}
  /* Plein écran : échelle en faveur des boutons, tout centré */
  body.fs header, body.fs footer, body.fs .form, body.fs .stat, body.fs .qrbar{display:none}
  body.fs .card{background:transparent;border:0;box-shadow:none;padding:0;width:100vw;max-width:100vw}
  body.fs .big{font-size:clamp(96px,32vmin,360px)}
  body.fs .btn{padding:26px 30px;font-size:clamp(30px,7.4vmin,64px)}
  body.fs .midbar{display:grid}
  body.fs .pill label{font-size:clamp(18px,3.2vmin,26px)}
  body.fs .pill input{font-size:clamp(30px,7.0vmin,58px)}
  body.fs .mid-right{display:none}
  .build{text-align:center;color:#94a3b8;margin-top:8px;font-size:13px}
</style>
<div class="wrap">
  <header><a class="back" href="./modes.html">← Modes</a></header>
  <main class="main">
    <div class="card">
      <h2 style="margin:6px 0 10px;text-align:center">Minuteur avec distance &amp; vitesse</h2>
      <div class="build">Build v6.3 — 2025-08-18</div>
      <!-- Formulaire (identité + paramètres) -->
      <div class="form">
        <div class="grid cols-5">
          <div class="fg"><div class="inner"><label>Nom</label><input id="nom" placeholder="Martin"></div></div>
          <div class="fg"><div class="inner"><label>Prénom</label><input id="prenom" placeholder="Julie"></div></div>
          <div class="fg"><div class="inner"><label>Classe</label><input id="classe" placeholder="4C"></div></div>
          <div class="fg"><div class="inner"><label>Sexe</label><select id="sexe"><option value="F">F</option><option value="M">M</option></select></div></div>
          <div class="fg"><div class="inner"><label>Piste (m)</label><input id="lapm" type="number" min="25" step="5" value="120" inputmode="numeric"></div></div>
        </div>
        <!-- Minutes & Secondes : centrés + couleur distincte -->
        <div class="grid time-row" style="margin-top:10px">
          <div class="fg fg-ms"><div class="inner"><label>Minutes</label><input id="mins" class="ms-input" type="number" min="0" step="1" value="6" inputmode="numeric"></div></div>
          <div class="fg fg-ms"><div class="inner"><label>Secondes</label><input id="secs" class="ms-input" type="number" min="0" max="59" step="1" value="0" inputmode="numeric"></div></div>
        </div>
        <!-- Champs techniques conservés (masqués) -->
        <div class="grid cols-5" style="display:none">
          <div class="fg"><div class="inner"><label>Tours comptés</label><input id="laps" type="number" value="0" disabled></div></div>
          <div class="fg"><div class="inner"><label>Distance totale (m)</label><input id="dist" type="number" value="0" disabled></div></div>
          <div class="fg"><div class="inner"><label>Fraction</label><input id="frac" type="text" value="0" disabled></div></div>
        </div>
      </div>
      <!-- Affichage temps + contrôles -->
      <div id="time" class="big">6:00</div>
      <div class="row">
        <button id="b-start" class="btn btn-acc">Lancer</button>
        <button id="b-lap" class="btn btn-ok" disabled>+1 tour</button>
        <button id="b-pause" class="btn btn-warn" disabled>Pause</button>
        <button id="b-reset" class="btn btn-dgr" disabled>Réinitialiser</button>
        <button id="b-full" class="btn btn-ok">Plein écran</button>
      </div>

      <!-- Midbar : valeurs + fraction (après course) -->
      <div class="midbar">
        <div class="mid-left">
          <div class="pill">
            <label>Nombre de tours</label>
            <input id="laps_display" value="0" disabled>
          </div>
          <div class="pill">
            <label>Distance totale (m)</label>
            <input id="dist_display" value="0" disabled>
          </div>
          <div class="pill">
            <label>Fraction</label>
            <input id="frac_display" value="0" disabled>
          </div>
        </div>
        <div class="mid-right">
          <div id="fraction" class="fraction-panel">
            <button class="chip chip-0" data-f="0">+ 0</button>
            <button class="chip chip-25" data-f="0.25">+ 1/4</button>
            <button class="chip chip-50" data-f="0.5">+ 1/2</button>
            <button class="chip chip-75" data-f="0.75">+ 3/4</button>
          </div>
        </div>
      </div>

      <!-- Statistiques vitesse / VMA -->
      <div class="stat">
        <div class="box"><div class="muted">Vitesse moyenne</div><b id="v-kmh">0.00 km/h</b></div>
        <div class="box"><div class="muted">VMA estimée (≥6’)</div><b id="vma">—</b></div>
      </div>

      <!-- QR -->
      <div class="row qrbar" style="margin-top:12px">
        <button id="b-qr" class="btn btn-acc" disabled>QR ScanProf</button>
      </div>
      <p class="muted" style="margin-top:6px">Fin de minuteur : choisissez la fraction de tour, puis générez le QR.</p>
    </div>
  </main>
  <footer>ChronoMinuteur - Equipe EPS Lycée Vauban - LUXEMBOURG - JB</footer>
</div>
<!-- Beep helpers -->
<script>
  let __AC__ = null;
  function audioCtx(){ const C = window.AudioContext || window.webkitAudioContext; if(!__AC__) __AC__ = new C(); if(__AC__.state==='suspended') __AC__.resume(); return __AC__; }
  function beep(freq=880, duration=0.18, volume=0.2){ const ac=audioCtx(); const o=ac.createOscillator(); const g=ac.createGain(); o.type='sine'; o.frequency.value=freq; g.gain.setValueAtTime(volume, ac.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime + duration); o.connect(g).connect(ac.destination); o.start(); o.stop(ac.currentTime + duration); }
  function patternStart(){ beep(880,0.18,0.25); }
  function patternEnd(){ beep(440,0.25,0.25); setTimeout(()=>beep(440,0.25,0.25), 120); }
</script>
<script>
  const $=s=>document.querySelector(s);
  let dur=6*60, remain=dur, run=false, t0=0, raf=null, startedOnce=false, counting=false;
  let laps=0, lapm=120, dist=0, fraction=0;
  function fmt(s){ s=Math.max(0,Math.round(s)); const m=Math.floor(s/60), ss=s%60; return m+':'+String(ss).padStart(2,'0'); }
  function kmh(m, s){ return (m>0 && s>0) ? (m/s)*3.6 : 0; }
  function computeDur(){ const m=Math.max(0,Number($('#mins').value)); const sec=Math.max(0,Math.min(59,Number($('#secs').value))); return m*60+sec; }
  function draw(){
    $('#time').textContent=fmt(remain);
    // Valeurs techniques conservées (compat code existant)
    const lapsEl=$('#laps'), distEl=$('#dist'), fracEl=$('#frac');
    if(lapsEl) lapsEl.value=String(laps);
    if(distEl) distEl.value=String(Math.round(dist));
    if(fracEl) fracEl.value=String(fraction);

    // Miroirs visuels dans la midbar
    $('#laps_display').value=String(laps);
    $('#dist_display').value=String(Math.round(dist));
    $('#frac_display').value=String(fraction);

    const v=kmh(dist, dur-remain); $('#v-kmh').textContent = v.toFixed(2)+' km/h';
    if(dur>=360){ $('#vma').textContent = v.toFixed(2)+' km/h'; } else { $('#vma').textContent='—'; }
  }
  function setInputs(){
    dur=Math.max(1,computeDur());
    lapm=Math.max(1,Number($('#lapm').value));
    if(!run){ remain=dur; draw(); }
  }
  $('#mins').oninput=setInputs; $('#secs').oninput=setInputs; $('#lapm').oninput=setInputs; setInputs();

  function tick(){ if(!run) return; const now=Date.now(); remain = dur - (now - t0)/1000;
    if(remain<=0){ remain=0; run=false; cancelAnimationFrame(raf);
      patternEnd();
      $('#b-start').disabled=false; $('#b-pause').disabled=true; $('#b-reset').disabled=false; $('#b-lap').disabled=true;
      // Affiche les chips fraction dans la midbar, à droite
      document.querySelector('.mid-right').style.display='flex';
      $('#b-qr').disabled=false;
    }
    draw(); if(run) raf=requestAnimationFrame(tick);
  }

  function doCountdown(cb){ if(counting) return; counting=true; let n=3; const ov=document.createElement('div'); ov.id='cd'; ov.style.cssText='position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.6);z-index:9999'; const d=document.createElement('div'); d.id='cdnum'; d.style.cssText='font-weight:900;font-size:clamp(96px,30vmin,360px);color:#fff'; d.textContent=n; ov.appendChild(d); document.body.appendChild(ov); beep(600,0.18,0.3);
    const iv=setInterval(()=>{ n--; if(n>0){ d.textContent=n; beep(600,0.18,0.3); } else { clearInterval(iv); ov.remove(); counting=false; patternStart(); cb && cb(); } }, 1000);
  }

  $('#b-start').onclick=()=>{ if(run||counting) return; if(!startedOnce){ doCountdown(()=>{ startedOnce=true; run=true; t0=Date.now()-(dur-remain)*1000;
      $('#b-start').disabled=true; $('#b-pause').disabled=false; $('#b-reset').disabled=true; $('#b-lap').disabled=false; document.querySelector('.mid-right').style.display='none'; $('#b-qr').disabled=true; fraction=0; dist=laps*lapm; draw(); tick();
    }); } else {
      run=true; t0=Date.now()-(dur-remain)*1000; $('#b-start').disabled=true; $('#b-pause').disabled=false; $('#b-reset').disabled=true; $('#b-lap').disabled=false; document.querySelector('.mid-right').style.display='none'; $('#b-qr').disabled=true; draw(); tick();
    }
  };
  $('#b-pause').onclick=()=>{ run=false; $('#b-start').disabled=false; $('#b-pause').disabled=true; $('#b-reset').disabled=false; };
  $('#b-reset').onclick=()=>{ run=false; remain=dur; laps=0; dist=0; fraction=0; startedOnce=false; draw(); $('#b-start').disabled=false; $('#b-pause').disabled=true; $('#b-reset').disabled=true; $('#b-lap').disabled=true; document.querySelector('.mid-right').style.display='none'; $('#b-qr').disabled=true; };
  $('#b-lap').onclick=()=>{ if(!run) return; laps+=1; dist = laps*lapm; draw(); };
  function toggleFS(){ if(!document.fullscreenElement){ document.documentElement.requestFullscreen(); } else { document.exitFullscreen(); } }
  $('#b-full').onclick=toggleFS;
  document.addEventListener('fullscreenchange', ()=>{ document.body.classList.toggle('fs', !!document.fullscreenElement); });

  document.querySelectorAll('.chip').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const f = Number(btn.dataset.f||0);
      fraction = f;
      dist = laps*lapm + fraction*lapm;
      draw();
    });
  });

  $('#b-qr').onclick=()=>{
    const nom=$('#nom').value.trim(), prenom=$('#prenom').value.trim(), classe=$('#classe').value.trim();
    let sexe=$('#sexe').value; sexe=(sexe==='M'||sexe==='F')?sexe:'F';
    if(!nom||!prenom||!classe){ alert('Identité incomplète.'); return; }
    const elapsed = dur - remain;
    const v = kmh(dist, elapsed);
    const payload = {
      nom, prenom, classe, sexe,
      Mode: "Minuteur distance",
      Duree_s: Math.round(dur),
      Piste_m: lapm,
      Tours: laps,
      Fraction: fraction,
      Distance_m: Math.round(dist),
      Vitesse_kmh: Number(v.toFixed(2)),
      VMA: (dur>=360) ? Number(v.toFixed(2)) : undefined
    };
    if(window.showQROverlay){ showQROverlay(payload, 'QR_'+nom+'_'+prenom); } else { alert('qr-overlay.js manquant'); }
  };
</script>
</body>
</html>
